@startuml "vc-authn-oidc-flow"
actor User
participant Browser as UserAgent
participant RP #red
participant IDP as OP
participant WalletedAgent as IdentityWallet

User -> UserAgent: Navigate to website
UserAgent -> RP: Fetch website
RP --> UserAgent: Return website
User -> UserAgent: Click "Login with OpenID Connect" button

RP -> UserAgent: Redirect for OIDC Authn
UserAgent -> OP: Follow Redirect

OP -> OP: Generate VC Presentation Request
OP -> UserAgent: Return VC Presentation Request

group WalletedAgent Communication Method
    alt QR Code Scanned By WalletedAgent
        loop Browser await WalletedAgent response
            UserAgent -> OP: Request challenge status
            OP --> UserAgent: "authentication_pending" response
        end
        note left: The Browser polls until the WalletedAgent responds to the request
        UserAgent -> IdentityWallet: Request Scanned
        IdentityWallet -> IdentityWallet: Request validated
        IdentityWallet -> User  : Present verify data request
        User -> IdentityWallet : Clicks accept request
        IdentityWallet -> IdentityWallet : Generate VC presentation
        IdentityWallet -> OP : Submit VC presentation
        UserAgent -> OP: Request challenge status
    end

    alt Deeplink invoked by WalletedAgent
        UserAgent -> IdentityWallet: Deeplink invoked
        IdentityWallet -> IdentityWallet: Request validated
        IdentityWallet -> User  : Present verify data request
        User -> IdentityWallet : Clicks accept request
        IdentityWallet -> IdentityWallet : Generate VC presentation
        IdentityWallet -> OP : Submit VC presentation
        IdentityWallet -> UserAgent: Redirect to URI
        UserAgent -> OP: Follow redirect
    end

    alt Agency chosen from list and redirect invoked
			UserAgent -> IdentityWallet: Follow Redirect
			IdentityWallet -> UserAgent: Request Login
			UserAgent -> IdentityWallet: Login with Username and Password
			IdentityWallet -> IdentityWallet: Request validated
			IdentityWallet -> User  : Present verify data request
			User -> IdentityWallet : Clicks accept request
			IdentityWallet -> IdentityWallet : Generate VC presentation
			IdentityWallet -> OP : Submit VC presentation
			IdentityWallet -> UserAgent: Redirect to URI
			UserAgent -> OP: Follow redirect
    end
end

group OAuth Flow
    alt Implicit Flow
        OP -> UserAgent: Redirect request with authorization code
        UserAgent -> RP: Follow redirect with authorization code
        RP -> OP: Request token with authorization code
        OP --> RP: Token response
    end

    alt Authorization Code Flow
        OP -> UserAgent: Redirect request with token
        UserAgent -> RP: Follow redirect with token
    end
end

RP --> UserAgent: Success web page
UserAgent --> User: ACK

@enduml
